---
title: "bhv_withinFC"
output: html_document
date: '2026-01-05'
---
## Import packages
```{r}
library(lme4)
library(lmerTest)
library(ggplot2)
library(performance)
```
# eLABE (Dataset 1)
```{r}
namestrs <- c("eLABE_Y2_N113_atleast600frames",
              "eLABE_Y3_N86")
data_list <- lapply(namestrs, function(ns) {
  df <- read.csv(paste0("within_FC_compare_ind_VS_grp_", ns, ".csv"))
  df$dataset <- ns              # optional: track dataset source
  return(df)
})

data <- do.call(rbind, data_list)
data$sub_id <- factor(data$sub_id)
```

```{r}
data$grp <- data$grp_23
data$ind <- data$ind_23

# Linear mixed effects model for association with age
## Baseline model (covariates only)
m0 <- lm(age_yrs ~ FD_mean_total, data = data)
# If adding sex:
# m0 <- lm(age_yrs ~ FD_mean_total + sex, data = data)

## Group-based feature
m_grp <- lm(age_yrs ~ FD_mean_total + grp, data = data)

## Individualized feature
m_ind <- lm(age_yrs ~ FD_mean_total + ind, data = data)

## R^2 and incremental variance explained (partial R^2 vs baseline)
r2_0   <- summary(m0)$r.squared
r2_grp <- summary(m_grp)$r.squared
r2_ind <- summary(m_ind)$r.squared

delta_grp <- r2_grp - r2_0
delta_ind <- r2_ind - r2_0

cat(sprintf("Baseline R^2: %.4f\n", r2_0))
cat(sprintf("Group model R^2: %.4f (ΔR^2 vs baseline = %.4f)\n", r2_grp, delta_grp))
cat(sprintf("Indiv model R^2: %.4f (ΔR^2 vs baseline = %.4f)\n", r2_ind, delta_ind))

## Optional: significance of adding grp_1 / ind_1 beyond covariates
anova(m0, m_grp)
anova(m0, m_ind)
```
```{r}
m_grp <- lm(age_yrs ~ FD_mean_total + grp_1+grp_2+grp_3+grp_4+grp_5+grp_6+grp_7+grp_8+grp_9+grp_10+grp_11+grp_12+grp_13+grp_14+grp_15+grp_16+grp_17+grp_18+grp_19+grp_20+grp_21+grp_22+grp_23, data = data)
summary(m_grp)

m_ind <- lm(age_yrs ~ FD_mean_total + ind_1+ind_2+ind_3+ind_4+ind_5+ind_6+ind_7+ind_8+ind_9+ind_10+ind_11+ind_12+ind_13+ind_14+ind_15+ind_16+ind_17+ind_18+ind_19+ind_20+ind_21+ind_22+ind_23, data = data)
summary(m_ind)
```

```{r}
library(MASS)

set.seed(123)

# ---- user inputs ----
subject_col <- "sub_id"
y_col <- "age_yrs"
fd_col <- "FD_mean_total"

grp_cols <- paste0("grp_", 1:23)
ind_cols <- paste0("ind_", 1:23)

# drop missing
data_cv <- data[, c(subject_col, y_col, fd_col, grp_cols, ind_cols)]
data_cv <- na.omit(data_cv)
data_cv[[subject_col]] <- as.factor(data_cv[[subject_col]])

# ---- grouped folds ----
make_group_folds <- function(subject, k = 5) {
  subs <- sample(levels(subject))
  fold_map <- rep(1:k, length.out = length(subs))
  names(fold_map) <- subs
  fold_map[as.character(subject)]
}

fold_id <- make_group_folds(data_cv[[subject_col]], 5)

# ---- helper: ridge CV ----
ridge_cv <- function(df, fold_id, y_col, base_cols, feat_cols, lambdas) {
  n <- nrow(df)
  pred <- rep(NA_real_, n)

  for (k in unique(fold_id)) {
    test <- which(fold_id == k)
    train <- which(fold_id != k)

    x_train <- as.matrix(df[train, c(base_cols, feat_cols)])
    y_train <- df[[y_col]][train]
    x_test <- as.matrix(df[test, c(base_cols, feat_cols)])

    # standardize using training stats
    mu <- colMeans(x_train)
    sdv <- apply(x_train, 2, sd)
    x_train <- scale(x_train, mu, sdv)
    x_test <- scale(x_test, mu, sdv)

    # inner CV to choose lambda
    cv_r2 <- sapply(lambdas, function(lam) {
      fit <- lm.ridge(y_train ~ x_train, lambda = lam)
      beta <- coef(fit)
      yhat <- cbind(1, x_train) %*% beta
      cor(yhat, y_train)^2
    })

    best_lam <- lambdas[which.max(cv_r2)]

    fit <- lm.ridge(y_train ~ x_train, lambda = best_lam)
    beta <- coef(fit)

    pred[test] <- cbind(1, x_test) %*% beta
  }

  y <- df[[y_col]]
  list(
    r = cor(pred, y),
    r2 = cor(pred, y)^2,
    rmse = sqrt(mean((pred - y)^2)),
    pred = pred
  )
}

lambdas <- seq(0, 50, length.out = 50)

# ---- run models ----
res_grp <- ridge_cv(data_cv, fold_id, y_col, fd_col, grp_cols, lambdas)
res_ind <- ridge_cv(data_cv, fold_id, y_col, fd_col, ind_cols, lambdas)

cat(sprintf("Group: r = %.3f, R2 = %.3f\n", res_grp$r, res_grp$r2))
cat(sprintf("Indiv: r = %.3f, R2 = %.3f\n", res_ind$r, res_ind$r2))

```

